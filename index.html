<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××¢×¨×›×ª × ×™×”×•×œ ××©×™××•×ª (Google Sheets)</title>
  <style>
    /* --- Base Styles --- */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    :root { --primary: #3498db; --primary-dark: #2980b9; --secondary: #2ecc71; --danger: #e74c3c; --warning: #f39c12; --light: #ecf0f1; --dark: #34495e; --border: #bdc3c7; --placeholder-bg: rgba(52, 152, 219, 0.1); }
    body { background-color: #f5f5f5; direction: rtl; overflow: hidden; height: 100vh; display: flex; position: relative; /* For loading overlay */ }
     /* Loading Overlay Style */
    .loading-overlay {
        position: fixed; /* Use fixed to cover the whole viewport */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999; /* Ensure it's on top */
        font-size: 1.3rem;
        color: var(--dark);
        backdrop-filter: blur(3px);
        transition: opacity 0.3s ease-in-out;
        opacity: 0; /* Hidden by default */
        pointer-events: none; /* Allow clicks through when hidden */
        flex-direction: column; /* Stack spinner and text */
        gap: 15px; /* Space between spinner and text */
    }
    .loading-overlay.active {
        opacity: 1;
        pointer-events: auto; /* Block clicks when visible */
    }
    /* Simple spinner */
    .spinner {
        border: 5px solid rgba(0, 0, 0, 0.1);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border-left-color: var(--primary);
        animation: spin 1s ease infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .main-container { display: flex; height: 100%; width: 100%; }

    /* --- Sidebar Styles --- */
    .sidebar { width: 300px; background-color: var(--dark); color: white; padding: 15px; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
    .sidebar h1, .sidebar h2 { margin-bottom: 15px; font-size: 1.4rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .sidebar h2 { font-size: 1.2rem; margin-top: 15px; }
    .task-form, .status-manager-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .task-form label, .status-manager-form label { font-weight: 500; margin-bottom: -5px; font-size: 0.9rem; }
    .task-form input, .task-form textarea, .task-form select, .status-manager-form input,
    .task-form input[type="date"], .task-form input[type="time"],
    .modal-form input[type="date"], .modal-form input[type="time"] { padding: 10px; border-radius: 5px; border: 1px solid var(--border); font-size: 0.95rem; width: 100%; background-color: #fff; color: #333; line-height: normal; height: 40px; }
    .task-form input[type="date"], .task-form input[type="time"], .modal-form input[type="date"], .modal-form input[type="time"] { padding: 8px 10px; cursor: pointer; }
    .task-form textarea { min-height: 80px; resize: vertical; }
    .add-task-btn, .add-status-btn { background-color: var(--secondary); color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; margin-top: 10px; transition: background-color 0.2s ease; }
    .add-task-btn:hover, .add-status-btn:hover { background-color: #27ae60; }
    .date-time-inputs { display: flex; gap: 8px; align-items: center; }
    .date-time-inputs input[type="date"] { flex-basis: 60%; }
    .date-time-inputs input[type="time"] { flex-basis: 40%; }

    /* --- Status Manager Styles --- */
    .status-manager { margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    .status-list { list-style: none; padding: 0; margin-bottom: 15px; max-height: 150px; overflow-y: auto; padding-right: 5px; }
    .status-list::-webkit-scrollbar { width: 6px; } .status-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 3px;} .status-list::-webkit-scrollbar-thumb { background: var(--primary-dark); border-radius: 3px;} .status-list::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    .status-list li { display: flex; align-items: center; justify-content: space-between; padding: 5px 8px; margin-bottom: 5px; background-color: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 0.9rem; }
    .status-list .status-color-indicator { width: 15px; height: 15px; border-radius: 50%; margin-left: 8px; border: 1px solid rgba(255,255,255,0.5); flex-shrink: 0; }
    .status-list .status-name { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-left: 5px; }
    .status-list .delete-status-btn { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.1rem; line-height: 1; padding: 0 4px; margin-right: -4px; opacity: 0.6; transition: opacity 0.2s; flex-shrink: 0; }
    .status-list .delete-status-btn:hover { opacity: 1; } .status-list .delete-status-btn[disabled] { opacity: 0.3; cursor: not-allowed; }
    .status-manager-form .color-picker-wrapper { display: flex; align-items: center; gap: 10px; }
    .status-manager-form input[type="color"] { padding: 2px; height: 38px; width: 50px; border: 1px solid var(--border); cursor: pointer; }

    /* --- Main Content Styles --- */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .tabs { display: flex; background-color: var(--dark); padding: 10px 15px 0; flex-shrink: 0; align-items: flex-end; overflow-x: auto; white-space: nowrap; scrollbar-width: thin; scrollbar-color: var(--primary-dark) var(--dark); }
    .tabs::-webkit-scrollbar { height: 6px; } .tabs::-webkit-scrollbar-track { background: var(--dark); } .tabs::-webkit-scrollbar-thumb { background: var(--primary-dark); border-radius: 3px; } .tabs::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    .tab { padding: 10px 15px; background-color: var(--light); margin-left: 5px; border-radius: 5px 5px 0 0; cursor: pointer; white-space: nowrap; display: inline-flex; align-items: center; max-width: 200px; border: 1px solid var(--border); border-bottom: none; position: relative; bottom: -1px; transition: background-color 0.2s ease; }
    .tab span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-left: 5px; }
    .tab.active { background-color: white; font-weight: bold; border-color: var(--border); border-bottom-color: white; z-index: 1; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
    .tab:not(.active):hover { background-color: #e0e6e8; }
    .tab button { background: none; border: none; cursor: pointer; font-size: 0.9rem; padding: 0 3px; line-height: 1; vertical-align: middle; opacity: 0.6; transition: opacity 0.2s; margin-right: 3px; }
    .tab button:hover { opacity: 1;} .tab .edit-tab-btn { color: var(--primary); margin-right: 5px; } .tab .delete-tab-btn { color: var(--danger); font-size: 1.1rem; margin-right: -2px;}
    .new-tab-btn { padding: 8px 12px; background-color: var(--primary); color: white; border: none; border-radius: 5px 5px 0 0; margin-right: 10px; cursor: pointer; flex-shrink: 0; font-weight: bold; border: 1px solid var(--primary-dark); border-bottom: none; height: 39px; line-height: 1; align-self: flex-end; transition: background-color 0.2s ease; }
    .new-tab-btn:hover { background-color: var(--primary-dark); }
    .boards-container { flex: 1; background-color: white; overflow-x: auto; overflow-y: hidden; padding: 20px; display: flex; border-top: 1px solid var(--border); scrollbar-width: thin; scrollbar-color: #ccc #eee; }
    .boards-container::-webkit-scrollbar { height: 10px; } .boards-container::-webkit-scrollbar-track { background: #eee; border-radius: 5px; } .boards-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; } .boards-container::-webkit-scrollbar-thumb:hover { background: #aaa; }
    .board { display: none; flex-grow: 1; height: 100%; }
    .board.active { display: flex; gap: 15px; width: 100%; overflow-y: hidden; align-items: flex-start; }
    .column { min-width: 270px; max-width: 290px; background-color: var(--light); border-radius: 5px; padding: 12px; display: flex; flex-direction: column; height: calc(100% - 10px); flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: box-shadow 0.2s ease, opacity 0.2s ease; cursor: grab; }
    .column:active { cursor: grabbing; }
    .column.dragging { opacity: 0.6; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: rotate(1deg); cursor: grabbing; }
    .column-drag-over-placeholder { min-width: 270px; max-width: 290px; height: 80px; border: 2px dashed var(--primary); background-color: var(--placeholder-bg); border-radius: 5px; flex-shrink: 0; margin: 0 7.5px; align-self: flex-start; box-sizing: border-box; }
    .column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); flex-shrink: 0; cursor: default; }
    .column-title { font-weight: bold; font-size: 1.05rem; color: var(--dark); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .column-actions button { background: none; border: none; cursor: pointer; color: var(--dark); font-size: 0.95rem; padding: 3px; opacity: 0.7; transition: opacity 0.2s; }
    .column-actions button:hover { opacity: 1; } .column-actions button + button { margin-right: 5px; }
    .tasks-container { flex: 1; overflow-y: auto; padding: 5px 2px 5px 5px; margin-right: -2px; min-height: 50px; scrollbar-width: thin; scrollbar-color: #ccc var(--light); cursor: default; pointer-events: auto; }
    .tasks-container::-webkit-scrollbar { width: 8px; } .tasks-container::-webkit-scrollbar-track { background: var(--light); border-radius: 4px; } .tasks-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; } .tasks-container::-webkit-scrollbar-thumb:hover { background: #aaa; }
    .add-column-btn { min-width: 270px; height: 45px; background-color: var(--placeholder-bg); border: 2px dashed var(--primary); border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); font-weight: bold; flex-shrink: 0; align-self: flex-start; transition: background-color 0.2s ease, border-style 0.2s ease; font-size: 0.95rem; }
    .add-column-btn:hover { background-color: rgba(52, 152, 219, 0.2); border-style: solid; }

    /* --- Task Card Styles --- */
    .task-card { background-color: white; border-radius: 5px; padding: 12px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); cursor: grab; border: 1px solid #eee; transition: box-shadow 0.2s ease, transform 0.1s ease, background-color 0.3s ease, border-color 0.3s ease, border-width 0.3s ease; pointer-events: auto; }
    .task-card:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.12); }
    .task-card:active { cursor: grabbing; background-color: #f9f9f9; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transform: scale(1.02); }
    .task-card.dragging { opacity: 0.5; border: 1px dashed #ccc; background: #f0f0f0; transform: none; }
    .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .task-title { font-weight: bold; margin-left: 5px; word-break: break-word; color: var(--dark); flex-grow: 1; font-size: 0.95rem; }
    .task-status { display: flex; gap: 5px; flex-shrink: 0; }
    .status-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.7rem; color: white; white-space: nowrap; font-weight: 500; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
    .status-badge.unknown { background-color: #7f8c8d; }
    .task-description { font-size: 0.85rem; color: #555; margin-bottom: 8px; word-break: break-word; line-height: 1.4; }
    .task-due-date { font-size: 0.8rem; color: #666; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #eee; line-height: 1.3; }
    .task-due-date strong { color: var(--dark); }
    .task-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 3px; }
    .task-actions button { border: none; background: none; cursor: pointer; padding: 4px; border-radius: 3px; font-size: 0.85rem; color: var(--dark); opacity: 0.6; transition: opacity 0.2s, background-color 0.2s; }
    .task-actions button:hover { background-color: var(--light); opacity: 1; }
    .task-card.due-alarm { background-color: #ffebee; border-width: 3px; border-style: solid; border-color: var(--danger); }
    .task-card.due-alarm .task-due-date { color: #c62828; font-weight: bold; }
    .task-card.due-alarm .task-actions button { color: #a12f2f; opacity: 0.7; }
    .task-card.due-alarm .task-actions button:hover { opacity: 1; background-color: #ffcdd2; }

    /* --- Modal Styles --- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px); padding: 15px; }
    .modal.active { display: flex; }
    .modal-content { background-color: white; padding: 25px; border-radius: 8px; width: 430px; max-width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
    .modal-title { font-weight: bold; font-size: 1.2rem; color: var(--dark); }
    .close-modal-btn { background: none; border: none; cursor: pointer; font-size: 1.7rem; color: #aaa; line-height: 1; transition: color 0.2s; }
    .close-modal-btn:hover { color: var(--danger); }
    .modal-form { display: flex; flex-direction: column; gap: 12px; }
    .modal-form label { font-weight: bold; margin-bottom: -8px; font-size: 0.85rem; color: var(--dark); }
    .modal-form input[type="text"], .modal-form textarea, .modal-form select,
    .modal-form input[type="date"], .modal-form input[type="time"] { padding: 10px; border-radius: 5px; border: 1px solid var(--border); font-size: 0.95rem; width: 100%; height: 40px; }
    .modal-form input[type="date"], .modal-form input[type="time"] { padding: 8px 10px; cursor: pointer; }
    .modal-form textarea { min-height: 100px; resize: vertical; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
    .modal-actions button { padding: 8px 16px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.2s, color 0.2s; font-size: 0.9rem; }
    .cancel-btn { background-color: var(--light); color: var(--dark); border: 1px solid var(--border); }
    .cancel-btn:hover { background-color: #dfe6e9; }
    .confirm-btn { background-color: var(--primary); color: white; }
    .confirm-btn:hover { background-color: var(--primary-dark); }

    /* Drag & Drop Placeholders */
    .drag-over { background-color: var(--placeholder-bg) !important; outline: 2px dashed var(--primary); outline-offset: -2px; }

    /* --- Mobile Responsiveness --- */
    @media (max-width: 768px) {
        body { overflow: auto; height: auto; } .main-container { flex-direction: column; height: auto; } .sidebar { width: 100%; height: auto; max-height: 45vh; padding: 10px; border-bottom: 2px solid var(--primary-dark); } .sidebar h1, .sidebar h2 { font-size: 1.2rem; margin-bottom: 10px; padding-bottom: 8px;} .sidebar h2 { font-size: 1.1rem; margin-top: 10px;} .task-form input, .task-form textarea, .task-form select, .status-manager-form input { font-size: 0.9rem; } .status-list { max-height: 100px; } .main-content { height: auto; flex-grow: 1; } .tabs { padding: 8px 10px 0; } .tab { padding: 8px 10px; max-width: 150px; font-size: 0.9rem;} .new-tab-btn { height: 35px; padding: 6px 10px; font-size: 0.9rem; margin-right: 5px;} .boards-container { padding: 15px; } .board.active { gap: 10px; } .column { min-width: 250px; max-width: 270px; padding: 10px;} .column-drag-over-placeholder { min-width: 250px; max-width: 270px; margin: 0 5px; } .column-title { font-size: 1rem; } .add-column-btn { min-width: 250px; height: 40px; font-size: 0.9rem;} .task-card { padding: 10px; margin-bottom: 6px; } .task-title { font-size: 0.9rem; } .task-description { font-size: 0.8rem; } .status-badge { font-size: 0.65rem; padding: 2px 8px;} .task-actions button { font-size: 0.8rem; padding: 3px;} .modal-content { width: 95%; padding: 20px; } .modal-title { font-size: 1.1rem; } .modal-form label { font-size: 0.8rem; } .modal-form input, .modal-form textarea, .modal-form select { font-size: 0.9rem; } .modal-actions button { padding: 7px 14px; font-size: 0.85rem; }
        .task-form input[type="date"], .task-form input[type="time"], .modal-form input[type="date"], .modal-form input[type="time"] { font-size: 0.9rem; height: 38px; }
        .task-due-date { font-size: 0.75rem; margin-top: 6px; padding-top: 4px; }
        .date-time-inputs { flex-direction: column; align-items: stretch; gap: 10px; }
        .date-time-inputs input[type="date"], .date-time-inputs input[type="time"] { flex-basis: auto; }
    }
    @media (max-width: 480px) {
        .column { min-width: 220px; max-width: 240px; } .column-drag-over-placeholder { min-width: 220px; max-width: 240px; } .add-column-btn { min-width: 220px; } .tab { max-width: 120px; font-size: 0.85rem;} .tab button { font-size: 0.8rem;} .task-title { font-size: 0.85rem; } .task-description { font-size: 0.75rem; }
        .task-due-date { font-size: 0.7rem; } .modal-form input[type="date"], .modal-form input[type="time"] { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <span id="loadingMessage">×˜×•×¢×Ÿ × ×ª×•× ×™×...</span>
  </div>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebarContainer">
      <h1>×”×•×¡×¤×ª ××©×™××” ×—×“×©×”</h1>
      <form class="task-form" id="taskForm">
        <label for="taskTitle">×›×•×ª×¨×ª:</label>
        <input type="text" id="taskTitle" placeholder="×›×•×ª×¨×ª ×”××©×™××”" required>
         <label for="taskDescription">×ª×™××•×¨:</label>
        <textarea id="taskDescription" placeholder="×ª×™××•×¨ ×”××©×™××”"></textarea>
        <label for="taskPriority">×¡×˜×˜×•×¡:</label>
        <select id="taskPriority"> </select>
        <label>×ª××¨×™×š ×•×©×¢×ª ×™×¢×“ (××•×¤×¦×™×•× ×œ×™):</label>
        <div class="date-time-inputs">
           <input type="date" id="taskDueDateDate" aria-label="×ª××¨×™×š ×™×¢×“">
           <input type="time" id="taskDueDateTime" aria-label="×©×¢×ª ×™×¢×“">
        </div>
        <button type="submit" class="add-task-btn">×”×•×¡×¤×ª ××©×™××”</button>
      </form>

      <div class="status-manager">
          <h2>× ×™×”×•×œ ×¡×˜×˜×•×¡×™×</h2>
          <ul class="status-list" id="statusList"> </ul>
          <form class="status-manager-form" id="statusForm">
              <label for="statusName">×©× ×¡×˜×˜×•×¡ ×—×“×©:</label>
              <input type="text" id="statusName" placeholder="×©× ×”×¡×˜×˜×•×¡" required>
              <label for="statusColor">×¦×‘×¢:</label>
              <div class="color-picker-wrapper">
                  <input type="color" id="statusColor" value="#3498db">
              </div>
              <button type="submit" class="add-status-btn">×”×•×¡×¤×ª ×¡×˜×˜×•×¡</button>
          </form>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="tabs" id="tabsContainer">
        <button class="new-tab-btn" id="newTabBtn" title="×”×•×¡×¤×ª ×¤×¨×•×™×§×˜ ×—×“×©">+</button>
      </div>
      <div class="boards-container" id="boardsContainer"> </div>
    </div>
  </div>

  <!-- Modals -->
   <div class="modal" id="addColumnModal"> <div class="modal-content"> <div class="modal-header"> <div class="modal-title">×”×•×¡×¤×ª ×¢××•×“×” ×—×“×©×”</div> <button class="close-modal-btn" data-modal-id="addColumnModal">Ã—</button> </div> <form class="modal-form" id="addColumnForm"> <label for="columnTitle">×©× ×”×¢××•×“×”:</label> <input type="text" id="columnTitle" placeholder="×©× ×”×¢××•×“×”" required> <input type="hidden" id="addColumnBoardId"> <div class="modal-actions"> <button type="button" class="cancel-btn" data-modal-id="addColumnModal">×‘×™×˜×•×œ</button> <button type="submit" class="confirm-btn">×”×•×¡×¤×”</button> </div> </form> </div> </div>
   <div class="modal" id="addBoardModal"> <div class="modal-content"> <div class="modal-header"> <div class="modal-title">×”×•×¡×¤×ª ×¤×¨×•×™×§×˜ ×—×“×©</div> <button class="close-modal-btn" data-modal-id="addBoardModal">Ã—</button> </div> <form class="modal-form" id="addBoardForm"> <label for="boardTitle">×©× ×”×¤×¨×•×™×§×˜:</label> <input type="text" id="boardTitle" placeholder="×©× ×”×¤×¨×•×™×§×˜" required> <div class="modal-actions"> <button type="button" class="cancel-btn" data-modal-id="addBoardModal">×‘×™×˜×•×œ</button> <button type="submit" class="confirm-btn">×”×•×¡×¤×”</button> </div> </form> </div> </div>
   <div class="modal" id="editTaskModal"> <div class="modal-content"> <div class="modal-header"> <div class="modal-title">×¢×¨×™×›×ª ××©×™××”</div> <button class="close-modal-btn" data-modal-id="editTaskModal">Ã—</button> </div> <form class="modal-form" id="editTaskForm"> <input type="hidden" id="editTaskId"> <input type="hidden" id="editTaskColumnId"> <input type="hidden" id="editTaskBoardId"> <label for="editTaskTitle">×›×•×ª×¨×ª:</label> <input type="text" id="editTaskTitle" required> <label for="editTaskDescription">×ª×™××•×¨:</label> <textarea id="editTaskDescription"></textarea> <label for="editTaskPriority">×¡×˜×˜×•×¡:</label> <select id="editTaskPriority"> </select>
   <label>×ª××¨×™×š ×•×©×¢×ª ×™×¢×“ (××•×¤×¦×™×•× ×œ×™):</label>
   <div class="date-time-inputs">
       <input type="date" id="editTaskDueDateDate" aria-label="×ª××¨×™×š ×™×¢×“">
       <input type="time" id="editTaskDueDateTime" aria-label="×©×¢×ª ×™×¢×“">
   </div>
   <div class="modal-actions"> <button type="button" class="cancel-btn" data-modal-id="editTaskModal">×‘×™×˜×•×œ</button> <button type="submit" class="confirm-btn">×©××™×¨×”</button> </div> </form> </div> </div>


  <script>
    // <![CDATA[
    // ========================================================================
    // STEP 0: PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
    // ========================================================================
    // Replace the placeholder below with the actual URL you got after deploying the script.
    // It looks like: https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby8Goz8cjUY_O5jku0bwbQ80rXNOpTNs50Iw-3-kz96gI6sUcEFxLGtBDnNIZtP_N2oQw/exec'; // <-- URL UPDATED HERE
    // ========================================================================


    document.addEventListener('DOMContentLoaded', () => {
      if (GAS_WEB_APP_URL === '×”×›× ×¡ ×›××Ÿ ××ª ×”×›×ª×•×‘×ª ×©×§×™×‘×œ×ª ××’×•×’×œ' || !GAS_WEB_APP_URL.startsWith('https://script.google.com/')) {
        alert('×©×’×™××ª ×ª×¦×•×¨×” ×—××•×¨×”!\n\n×× × ×¤×ª×— ××ª ×§×•×‘×¥ ×”-HTML ×‘×¢×•×¨×š ×˜×§×¡×˜ ×•×¢×“×›×Ÿ ××ª ×”××©×ª× ×” `GAS_WEB_APP_URL` ×¢× ×”×›×ª×•×‘×ª ×”× ×›×•× ×” ×©×œ Google Apps Script Web App ×©×¤×¨×¡××ª.');
        document.body.innerHTML = '<h1 style="color: red; padding: 50px; text-align: center; direction: ltr;">Configuration Error: Please update the `GAS_WEB_APP_URL` variable in the HTML source code with your deployed Google Apps Script Web App URL.</h1>';
        return; // Stop execution
      }

      // --- Client-side state cache ---
      let appState = { boards: [], activeBoardId: null, customStatuses: [] };
      let isLoading = false;

      // --- DOM Elements ---
      const loadingOverlay = document.getElementById('loadingOverlay');
      const loadingMessage = document.getElementById('loadingMessage');
      const sidebarContainer = document.getElementById('sidebarContainer');
      const tabsContainer = document.getElementById('tabsContainer');
      const boardsContainer = document.getElementById('boardsContainer');
      const taskForm = document.getElementById('taskForm');
      const statusForm = document.getElementById('statusForm');
      const statusList = document.getElementById('statusList');
      const newTabBtn = document.getElementById('newTabBtn');
      const addColumnModal = document.getElementById('addColumnModal');
      const addBoardModal = document.getElementById('addBoardModal');
      const editTaskModal = document.getElementById('editTaskModal');
      const addColumnForm = document.getElementById('addColumnForm');
      const addBoardForm = document.getElementById('addBoardForm');
      const editTaskForm = document.getElementById('editTaskForm');
      const taskPrioritySelect = document.getElementById('taskPriority');
      const editTaskPrioritySelect = document.getElementById('editTaskPriority');
      const taskDueDateDateInput = document.getElementById('taskDueDateDate');
      const taskDueDateTimeInput = document.getElementById('taskDueDateTime');
      const editTaskDueDateDateInput = document.getElementById('editTaskDueDateDate');
      const editTaskDueDateTimeInput = document.getElementById('editTaskDueDateTime');

      // --- Loading Indicator ---
      function showLoading(message = '××¢×‘×“ × ×ª×•× ×™×...') {
        if (!loadingOverlay || !loadingMessage) { console.error("Loading overlay elements not found!"); return; }
        isLoading = true;
        loadingMessage.textContent = message;
        loadingOverlay.classList.add('active');
      }
      function hideLoading() {
        if (!loadingOverlay) return;
        isLoading = false;
        loadingOverlay.classList.remove('active');
      }

      // --- Google Apps Script Communication ---
      async function callGoogleScript(action, payload = {}) {
          if (isLoading) { console.warn("Operation blocked: Pending request."); return { success: false, message: "Operation blocked", blocked: true }; }
          showLoading(getLoadingMessage(action));
          try {
              const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', redirect: 'follow', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: action, payload: payload }) });
              if (!response.ok) { const errorText = await response.text(); console.error('GAS HTTP Error:', response.status, errorText); throw new Error(`×©×’×™××ª ×©×¨×ª (${response.status}). × ×¡×” ×©×•×‘. ×¤×¨×˜×™×: ${errorText.slice(0, 100)}`); }
              const result = await response.json();
              if (!result || typeof result.success === 'undefined') { console.error('Invalid GAS response:', result); throw new Error('×ª×’×•×‘×” ×œ× ×ª×§×™× ×” ××”×©×¨×ª.'); }
              if (!result.success) { console.error('GAS Operation Error:', result.message, result.error); throw new Error(result.message || '×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×¤×¢×•×œ×” ×‘×©×¨×ª.'); }
              hideLoading(); return result;
          } catch (error) { console.error(`Error calling GAS action '${action}':`, error); hideLoading(); alert(`×©×’×™××ª ×ª×§×©×•×¨×ª: ${error.message}`); return { success: false, message: error.message, error: error }; }
      }
      function getLoadingMessage(action) { /* ... [Same as previous version] ... */ switch(action){case 'getAllData':return '×˜×•×¢×Ÿ × ×ª×•× ×™×...';case 'addTask':return '××•×¡×™×£ ××©×™××”...';case 'updateTask':return '××¢×“×›×Ÿ ××©×™××”...';case 'deleteTask':return '××•×—×§ ××©×™××”...';case 'moveTask':return '××¢×‘×™×¨ ××©×™××”...';case 'addColumn':return '××•×¡×™×£ ×¢××•×“×”...';case 'deleteColumn':return '××•×—×§ ×¢××•×“×”...';case 'moveColumn':return '××¢×‘×™×¨ ×¢××•×“×”...';case 'addBoard':return '××•×¡×™×£ ×¤×¨×•×™×§×˜...';case 'deleteBoard':return '××•×—×§ ×¤×¨×•×™×§×˜...';case 'addStatus':return '××•×¡×™×£ ×¡×˜×˜×•×¡...';case 'deleteStatus':return '××•×—×§ ×¡×˜×˜×•×¡...';case 'updateColumnTitle':return '××¢×“×›×Ÿ ×©× ×¢××•×“×”...';case 'updateBoardTitle':return '××¢×“×›×Ÿ ×©× ×¤×¨×•×™×§×˜...';default:return '××¢×‘×“ × ×ª×•× ×™×...';} }

      // --- UTILITY Functions ---
      function generateId(prefix = 'id') { return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; }
      function getStatusInfo(statusId) { const status = appState.customStatuses.find(s => s.id === statusId); return status ? { text: status.name, color: status.color, class: 'custom-status' } : { text: '×œ× ×™×“×•×¢', color: '#7f8c8d', class: 'unknown' }; }
      function escapeHTML(str) { return String(str).replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>').replace(/"/g, '"').replace(/'/g, '''); }
      function isLightColor(hexColor) { if (!hexColor || typeof hexColor !== 'string' || hexColor.length < 4) return true; let c = hexColor.substring(1); if (c.length === 3) c = c[0]+c[0]+c[1]+c[1]+c[2]+c[2]; if (c.length !== 6) return true; try { const r = parseInt(c.substring(0, 2), 16), g = parseInt(c.substring(2, 4), 16), b = parseInt(c.substring(4, 6), 16); return ((0.2126*r + 0.7152*g + 0.0722*b) / 255) > 0.6; } catch(e){ return true; } }
      function formatDateTime(isoString) { if (!isoString) return null; try { const date = new Date(isoString); if (isNaN(date)) return null; return `${date.toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'numeric'})} ${date.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit',hour12:false})}`; } catch(e){ console.error("Err format date:", isoString, e); return null; } }

      // --- RENDERING Functions ---
      function populateStatusSelects() { const selects = [taskPrioritySelect, editTaskPrioritySelect]; selects.forEach(select => { if (!select) return; const currentVal = select.value; select.innerHTML = ''; if (appState.customStatuses.length === 0) { select.innerHTML = '<option value="" disabled>××™×Ÿ ×¡×˜×˜×•×¡×™×</option>'; select.disabled = true; return; } select.disabled = false; appState.customStatuses.forEach(status => { const option = document.createElement('option'); option.value = status.id; option.textContent = status.name; select.appendChild(option); }); if (appState.customStatuses.some(s => s.id === currentVal)) { select.value = currentVal; } else if (appState.customStatuses.length > 0) { select.value = appState.customStatuses[0].id; } }); }
      function renderStatusManager() { if (!statusList) return; statusList.innerHTML = ''; const canDelete = appState.customStatuses.length > 1; if (appState.customStatuses.length === 0) { statusList.innerHTML = '<li>××™×Ÿ ×¡×˜×˜×•×¡×™× ××•×’×“×¨×™×.</li>'; } else { appState.customStatuses.forEach(status => { const li = document.createElement('li'); li.dataset.statusId = status.id; li.innerHTML = `<span class="status-color-indicator" style="background-color: ${escapeHTML(status.color)};"></span> <span class="status-name" title="${escapeHTML(status.name)}">${escapeHTML(status.name)}</span> <button class="delete-status-btn" data-status-id="${escapeHTML(status.id)}" title="××—×§ ×¡×˜×˜×•×¡" ${!canDelete ? 'disabled' : ''}>Ã—</button>`; statusList.appendChild(li); }); } populateStatusSelects(); }
      function renderTask(task) { const taskCard = document.createElement('div'); taskCard.className = 'task-card'; taskCard.draggable = true; taskCard.dataset.taskId = task.id; const statusInfo = getStatusInfo(task.status); const textColor = isLightColor(statusInfo.color) ? '#000' : '#fff'; let statusBadgeHTML = `<div class="status-badge ${escapeHTML(statusInfo.class)}" style="background-color: ${escapeHTML(statusInfo.color)}; color: ${textColor};" title="${escapeHTML(statusInfo.text)}">${escapeHTML(statusInfo.text)}</div>`; const titleDiv = document.createElement('div'); titleDiv.className = 'task-title'; titleDiv.textContent = task.title; const descriptionDiv = document.createElement('div'); descriptionDiv.className = 'task-description'; descriptionDiv.textContent = task.description; let dueDateHTML = ''; let isDue = false; if (task.dueDate) { try { const dueDate = new Date(task.dueDate); if (!isNaN(dueDate) && dueDate < new Date()) isDue = true; dueDateHTML = `<div class="task-due-date"><strong>×ª××¨×™×š ×™×¢×“:</strong> ${escapeHTML(formatDateTime(task.dueDate)||"???")}</div>`; } catch (e) { console.error("Err parsing dueDate", e); } } if (isDue) taskCard.classList.add('due-alarm'); taskCard.innerHTML = `<div class="task-header"> ${titleDiv.outerHTML} <div class="task-status">${statusBadgeHTML}</div> </div> ${descriptionDiv.outerHTML} ${dueDateHTML} <div class="task-actions"><button class="edit-task-btn" title="×¢×¨×™×›×ª ××©×™××”">âœï¸</button><button class="delete-task-btn" title="××—×™×§×ª ××©×™××”">ğŸ—‘ï¸</button></div>`; taskCard.addEventListener('dragstart', handleTaskDragStart); taskCard.addEventListener('dragend', handleTaskDragEnd); return taskCard; }
      function renderColumn(column, boardId) { const columnDiv = document.createElement('div'); columnDiv.className = 'column'; columnDiv.id = column.id; columnDiv.dataset.columnId = column.id; columnDiv.dataset.boardId = boardId; columnDiv.draggable = true; const header = document.createElement('div'); header.className = 'column-header'; const title = document.createElement('div'); title.className = 'column-title'; title.textContent = column.title; title.title = column.title; const actions = document.createElement('div'); actions.className = 'column-actions'; actions.innerHTML = `<button class="edit-column-btn" title="×©×™× ×•×™ ×©× ×¢××•×“×”">âœï¸</button><button class="delete-column-btn" title="××—×™×§×ª ×¢××•×“×”">ğŸ—‘ï¸</button>`; header.appendChild(title); header.appendChild(actions); const tasksContainer = document.createElement('div'); tasksContainer.className = 'tasks-container'; columnDiv.appendChild(header); columnDiv.appendChild(tasksContainer); column.tasks.forEach(task => { tasksContainer.appendChild(renderTask(task)); }); tasksContainer.addEventListener('dragover', handleTaskDragOver); tasksContainer.addEventListener('dragleave', handleTaskDragLeave); tasksContainer.addEventListener('drop', handleTaskDrop); columnDiv.addEventListener('dragstart', handleColumnDragStart); columnDiv.addEventListener('dragend', handleColumnDragEnd); return columnDiv; }
      function renderBoard(board) { const boardDiv = document.createElement('div'); boardDiv.className = 'board'; boardDiv.id = board.id; if (board.id === appState.activeBoardId) { boardDiv.classList.add('active'); boardDiv.addEventListener('dragover', handleColumnDragOver); boardDiv.addEventListener('dragleave', handleColumnDragLeave); boardDiv.addEventListener('drop', handleColumnDrop); } board.columns.forEach(column => { boardDiv.appendChild(renderColumn(column, board.id)); }); const addColumnBtn = document.createElement('div'); addColumnBtn.className = 'add-column-btn'; addColumnBtn.textContent = '+ ×”×•×¡×¤×ª ×¢××•×“×”'; addColumnBtn.dataset.boardId = board.id; addColumnBtn.title = '×”×•×¡×¤×ª ×¢××•×“×” ×—×“×©×” ×œ×¤×¨×•×™×§×˜ ×–×”'; addColumnBtn.addEventListener('click', () => openAddColumnModal(board.id)); boardDiv.appendChild(addColumnBtn); return boardDiv; }
      function renderTabs() { const addBtnRef = tabsContainer.querySelector('.new-tab-btn') || newTabBtn; tabsContainer.innerHTML = ''; tabsContainer.appendChild(addBtnRef); if (appState.boards.length === 0) { const noBoardsMsg = document.createElement('div'); noBoardsMsg.textContent = "××™×Ÿ ×¤×¨×•×™×§×˜×™×. ×œ×—×¥ ×¢×œ '+' ×œ×”×•×¡×¤×”."; noBoardsMsg.style.cssText = 'padding: 10px 15px; color: var(--light); align-self: center;'; tabsContainer.insertBefore(noBoardsMsg, addBtnRef); } appState.boards.forEach(board => { const tab = document.createElement('div'); tab.className = 'tab'; tab.dataset.boardId = board.id; const titleSpan = document.createElement('span'); titleSpan.textContent = board.title; titleSpan.title = board.title; tab.appendChild(titleSpan); if (board.id === appState.activeBoardId) tab.classList.add('active'); tab.addEventListener('click', (e) => { if (e.target === tab || e.target === titleSpan) switchTab(board.id); }); const editBtn = document.createElement('button'); editBtn.innerHTML = 'âœï¸'; editBtn.className = 'edit-tab-btn'; editBtn.title = '×©× ×” ×©× ×¤×¨×•×™×§×˜'; editBtn.setAttribute('aria-label', `×¢×¨×•×š ${escapeHTML(board.title)}`); editBtn.onclick = (e) => { e.stopPropagation(); editBoardTitle(board.id); }; tab.appendChild(editBtn); const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = 'Ã—'; deleteBtn.className = 'delete-tab-btn'; deleteBtn.title = '××—×§ ×¤×¨×•×™×§×˜'; deleteBtn.setAttribute('aria-label', `××—×§ ${escapeHTML(board.title)}`); deleteBtn.onclick = (e) => { e.stopPropagation(); deleteBoard(board.id); }; tab.appendChild(deleteBtn); tabsContainer.insertBefore(tab, addBtnRef); }); }
      function renderApp() { console.time("renderApp"); renderStatusManager(); renderTabs(); boardsContainer.querySelectorAll('.board').forEach(b => { b.removeEventListener('dragover', handleColumnDragOver); b.removeEventListener('dragleave', handleColumnDragLeave); b.removeEventListener('drop', handleColumnDrop); }); boardsContainer.innerHTML = ''; appState.boards.forEach(board => { boardsContainer.appendChild(renderBoard(board)); }); const activeBoardEl = appState.activeBoardId ? document.getElementById(appState.activeBoardId) : null; if (activeBoardEl) { document.querySelectorAll('.board.active').forEach(b => b.classList.remove('active')); activeBoardEl.classList.add('active'); activeBoardEl.removeEventListener('dragover', handleColumnDragOver); activeBoardEl.removeEventListener('dragleave', handleColumnDragLeave); activeBoardEl.removeEventListener('drop', handleColumnDrop); activeBoardEl.addEventListener('dragover', handleColumnDragOver); activeBoardEl.addEventListener('dragleave', handleColumnDragLeave); activeBoardEl.addEventListener('drop', handleColumnDrop); } else if (appState.boards.length > 0) { console.warn(`Active board ID ${appState.activeBoardId} invalid/missing. Activating first.`); appState.activeBoardId = appState.boards[0].id; const firstBoardEl = document.getElementById(appState.activeBoardId); if(firstBoardEl) { firstBoardEl.classList.add('active'); firstBoardEl.addEventListener('dragover', handleColumnDragOver); firstBoardEl.addEventListener('dragleave', handleColumnDragLeave); firstBoardEl.addEventListener('drop', handleColumnDrop); document.querySelectorAll('.tab.active').forEach(t => t.classList.remove('active')); const activeTab = tabsContainer.querySelector(`.tab[data-board-id="${appState.activeBoardId}"]`); if(activeTab) activeTab.classList.add('active'); } } else { boardsContainer.innerHTML = '<div style="padding: 30px; color: #777; text-align: center; width: 100%;">××™×Ÿ ×¤×¨×•×™×§×˜×™×. ×”×•×¡×£ ×¤×¨×•×™×§×˜ ×›×“×™ ×œ×”×ª×—×™×œ.</div>'; } setupDelegatedListeners(); console.timeEnd("renderApp"); checkDueDates(); }

      // --- EVENT HANDLERS & ACTIONS (Calls GAS) ---
      let draggedTaskElement = null; let sourceTaskColumnId = null; let sourceTaskBoardId = null;
      function handleTaskDragStart(e) { /* ... [Same as previous version] ... */ if(!e.target.classList.contains('task-card')){e.preventDefault();return;} e.stopPropagation();draggedTaskElement=e.target;const t=draggedTaskElement.closest('.column'),o=draggedTaskElement.closest('.board');if(!t||!o){e.preventDefault();return;}sourceTaskColumnId=t.dataset.columnId,sourceTaskBoardId=o.id,e.dataTransfer.setData('text/plain',draggedTaskElement.dataset.taskId),e.dataTransfer.effectAllowed='move',setTimeout(()=>{draggedTaskElement?.classList.add('dragging')},0); }
      function handleTaskDragEnd(e) { /* ... [Same as previous version] ... */ draggedTaskElement?.classList.remove('dragging'),draggedTaskElement=null,sourceTaskColumnId=null,sourceTaskBoardId=null,document.querySelectorAll('.tasks-container.drag-over').forEach(e=>e.classList.remove('drag-over')); }
      function handleTaskDragOver(e) { /* ... [Same as previous version] ... */ if(!draggedTaskElement)return;e.preventDefault(),e.dataTransfer.dropEffect='move';const t=e.target.closest('.tasks-container');t?t.classList.contains('drag-over')||(document.querySelectorAll('.tasks-container.drag-over').forEach(e=>e.classList.remove('drag-over')),t.classList.add('drag-over')):document.querySelectorAll('.tasks-container.drag-over').forEach(e=>e.classList.remove('drag-over')); }
      function handleTaskDragLeave(e) { /* ... [Same as previous version] ... */ if(!draggedTaskElement)return;const t=e.target.closest('.tasks-container');t&&(!e.relatedTarget||!t.contains(e.relatedTarget))&&t.classList.remove('drag-over'); }
      async function handleTaskDrop(e) {
           if (!draggedTaskElement) return; e.preventDefault(); e.stopPropagation(); const t=e.target.closest('.tasks-container'); if(!t){handleTaskDragEnd(e);return} t.classList.remove('drag-over');const o=t.closest('.column');if(!o){handleTaskDragEnd(e);return} const n=o.dataset.columnId,r=o.dataset.boardId,d=e.dataTransfer.getData('text/plain');if(sourceColumnId===n&&t.contains(draggedTaskElement));const a=e.clientY,s=Array.from(t.querySelectorAll('.task-card:not(.dragging)'));let l=s.length;for(let c=0;c<s.length;c++){const i=s[c],u=i.getBoundingClientRect();if(a<u.top+u.height/2){l=c;break}} const g=document.querySelector(`#${sourceColumnId} .tasks-container`),m=document.createElement('div');let p=s[l]||null;t.insertBefore(m,p),t.insertBefore(draggedTaskElement,m),m.remove(); const f = await callGoogleScript('moveTask',{taskId:d,sourceColumnId:sourceColumnId,targetColumnId:n,newIndex:l}); f.success?(console.log(`Task ${d} moved to Col ${n} at index ${l}`),updateLocalStateAfterTaskMove(r,sourceColumnId,n,d,l)):(alert("×©×’×™××” ×‘×”×–×–×ª ×”××©×™××”. ××—×–×™×¨ ×œ××§×•×."),g?g.appendChild(draggedTaskElement):await fetchDataFromSheet(),renderApp()),handleTaskDragEnd(e);
      }
      function updateLocalStateAfterTaskMove(boardId, srcColId, tgtColId, taskId, newIndex){ const board = appState.boards.find(b=>b.id===boardId); const sourceCol=board?.columns.find(c=>c.id===srcColId), targetCol=board?.columns.find(c=>c.id===tgtColId); if(sourceCol && targetCol){const idx=sourceCol.tasks.findIndex(t=>t.id===taskId); if(idx>-1){const[task]=sourceCol.tasks.splice(idx,1);targetCol.tasks.splice(newIndex,0,task);} else console.error("Task not found in src state?") } else console.error("Board/Col not found?") }

      let draggedColumnElement = null; let sourceColumnBoardId = null; let placeholder = null;
      function createPlaceholder() { if (!placeholder) { placeholder = document.createElement('div'); placeholder.className = 'column-drag-over-placeholder'; } return placeholder; }
      function handleColumnDragStart(e) { /* ... [Same as previous version] ... */ if(!e.target.classList.contains('column')||e.target.closest('.tasks-container')||e.target.closest('.column-header')){if(!draggedTaskElement)e.preventDefault();return} if(draggedTaskElement){e.preventDefault();return} draggedColumnElement=e.target,sourceColumnBoardId=draggedColumnElement.closest('.board').id;if(sourceColumnBoardId!==appState.activeBoardId){e.preventDefault(),draggedColumnElement=null;return} e.dataTransfer.setData('text/plain',draggedColumnElement.dataset.columnId),e.dataTransfer.effectAllowed='move',setTimeout(()=>{draggedColumnElement?.classList.add('dragging')},0),placeholder=createPlaceholder(); }
      function handleColumnDragEnd(e) { /* ... [Same as previous version] ... */ draggedColumnElement?.classList.remove('dragging'),placeholder?.remove(),placeholder=null,draggedColumnElement=null,sourceColumnBoardId=null; }
      function handleColumnDragOver(e) { /* ... [Same as previous version] ... */ if(!draggedColumnElement||draggedTaskElement)return;e.preventDefault(),e.dataTransfer.dropEffect='move';const t=e.target.closest('.board.active');if(!t||!placeholder)return;const o=getColumnDragAfterElement(t,e.clientX),n=t.querySelector('.add-column-btn');null==o?n?t.insertBefore(placeholder,n):t.appendChild(placeholder):t.insertBefore(placeholder,o); }
      function getColumnDragAfterElement(boardElement, x) { const e=[...boardElement.querySelectorAll('.column:not(.dragging):not(.add-column-btn)')];return e.reduce((e,t)=>{const o=t.getBoundingClientRect(),n=x-(o.left+o.width/2);return n<0&&n>e.offset?{offset:n,element:t}:e},{offset:Number.NEGATIVE_INFINITY}).element; }
      function handleColumnDragLeave(e) { /* ... [Same as previous version] ... */ if(!draggedColumnElement||draggedTaskElement)return;const t=e.target.closest('.board.active');placeholder&&t&&(!e.relatedTarget||!t.contains(e.relatedTarget))&&placeholder.remove(); }
      async function handleColumnDrop(e) {
           if(!draggedColumnElement||draggedTaskElement){placeholder?.remove();return} e.preventDefault();const t=e.target.closest('.board.active');if(!t||!placeholder||!placeholder.parentNode){handleColumnDragEnd(e);return} const o=t.id,n=e.dataTransfer.getData('text/plain'),r=[...t.querySelectorAll('.column:not(.dragging)')];let d=r.indexOf(placeholder);d===-1&&(d=r.length);t.insertBefore(draggedColumnElement,placeholder);const a=await callGoogleScript('moveColumn',{boardId:o,columnId:n,newIndex:d});a.success?(console.log(`Column ${n} moved to index ${d}`),updateLocalStateAfterColMove(o,n,d)):(alert("×©×’×™××” ×‘×”×–×–×ª ×”×¢××•×“×”."),await fetchDataFromSheet()),handleColumnDragEnd(e);
      }
       function updateLocalStateAfterColMove(boardId, colId, newIndex){ const board=appState.boards.find(b=>b.id===boardId); if(board){const idx=board.columns.findIndex(c=>c.id===colId); if(idx>-1){const[col]=board.columns.splice(idx,1);board.columns.splice(newIndex,0,col);}else console.error("Col not found?")}else console.error("Board not found?")}

      function switchTab(boardId) { /* ... [Same - No GAS call needed] ... */ if(appState.activeBoardId===boardId)return;const t=appState.activeBoardId?document.getElementById(appState.activeBoardId):null;t&&(t.removeEventListener('dragover',handleColumnDragOver),t.removeEventListener('dragleave',handleColumnDragLeave),t.removeEventListener('drop',handleColumnDrop),t.classList.remove('active')),appState.activeBoardId=boardId,tabsContainer.querySelectorAll('.tab').forEach(e=>e.classList.toggle('active',e.dataset.boardId===boardId));const o=document.getElementById(boardId);o?(boardsContainer.querySelectorAll('.board.active').forEach(e=>e.classList.remove('active')),o.classList.add('active'),o.removeEventListener('dragover',handleColumnDragOver),o.removeEventListener('dragleave',handleColumnDragLeave),o.removeEventListener('drop',handleColumnDrop),o.addEventListener('dragover',handleColumnDragOver),o.addEventListener('dragleave',handleColumnDragLeave),o.addEventListener('drop',handleColumnDrop)):console.error(`SwitchTab Error: Board element ${boardId} not found.`);const n=tabsContainer.querySelector('.tab.active');n&&n.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'}); }
      function openAddColumnModal(boardId) { /* ... [Same as previous version] ... */ const e=appState.boards.find(e=>e.id===boardId);e&&(document.getElementById('addColumnBoardId').value=boardId,addColumnModal.classList.add('active'),document.getElementById('columnTitle').focus()); }
      function openAddBoardModal() { /* ... [Same as previous version] ... */ addBoardModal.classList.add('active'),document.getElementById('boardTitle').focus(); }
      function openEditTaskModal(taskId, columnId, boardId) { /* ... [Same as previous version] ... */ const e=appState.boards.find(e=>e.id===boardId),t=e?.columns.find(e=>e.id===columnId),o=t?.tasks.find(e=>e.id===taskId);o&&(document.getElementById('editTaskId').value=o.id,document.getElementById('editTaskColumnId').value=columnId,document.getElementById('editTaskBoardId').value=boardId,document.getElementById('editTaskTitle').value=o.title,document.getElementById('editTaskDescription').value=o.description||'',populateStatusSelects(),editTaskPrioritySelect.value=o.status||(appState.customStatuses[0]?.id||''),o.dueDate&&typeof o.dueDate=='string'&&o.dueDate.includes('T')?(editTaskDueDateDateInput.value=o.dueDate.split('T')[0]||'',editTaskDueDateTimeInput.value=o.dueDate.split('T')[1]||''):(editTaskDueDateDateInput.value='',editTaskDueDateTimeInput.value=''),editTaskModal.classList.add('active'),document.getElementById('editTaskTitle').focus()); }
      function closeModal(modalId) { /* ... [Same as previous version] ... */ const e=document.getElementById(modalId);if(e){e.classList.remove('active');const t=e.querySelector('form');t&&t.reset();const o=e.querySelector('input[type="color"]');o&&(o.value='#3498db');} }

      // --- FORM SUBMISSIONS and ACTIONS (Calls GAS) ---
      statusForm.addEventListener('submit', async (e) => { e.preventDefault();const t=document.getElementById('statusName'),o=document.getElementById('statusColor'),n=t.value.trim(),r=o.value;if(!n)return alert("×©× ×¡×˜×˜×•×¡ ×—×•×‘×”."),void t.focus();if(appState.customStatuses.some(e=>e.name.toLowerCase()===n.toLowerCase()))return alert("×¡×˜×˜×•×¡ ×¢× ×©× ×–×” ×§×™×™×."),void t.focus();const d={id:generateId('status'),name:n,color:r},a=await callGoogleScript('addStatus',d);a.success&&a.data&&(appState.customStatuses.push(a.data),renderStatusManager(),statusForm.reset(),o.value='#3498db',t.focus()); });
      taskForm.addEventListener('submit', async (e) => { e.preventDefault();if(!appState.activeBoardId)return alert("×× × ×‘×—×¨ ×¤×¨×•×™×§×˜.");const t=appState.boards.find(e=>e.id===appState.activeBoardId);if(!t||0===t.columns.length)return alert(t?"×™×© ×œ×”×•×¡×™×£ ×¢××•×“×” ×œ×¤×¨×•×™×§×˜.":"×¤×¨×•×™×§×˜ ×¤×¢×™×œ ×œ× × ××¦×.");const o=document.getElementById('taskTitle').value.trim(),n=document.getElementById('taskDescription').value.trim(),r=taskPrioritySelect.value,d=taskDueDateDateInput.value,a=taskDueDateTimeInput.value;if(!o||!r)return alert(o?"×¡×˜×˜×•×¡ ×—×•×‘×”.":"×›×•×ª×¨×ª ×—×•×‘×”.");let s=null;if(d&&a)s=`${d}T${a}`;else if(d)return alert("×™×© ×œ×¡×¤×§ ×’× ×©×¢×ª ×™×¢×“.");const l=t.columns[0].id,c={id:generateId('task'),title:o,description:n,status:r,dueDate:s,columnId:l},i=await callGoogleScript('addTask',c);if(i.success&&i.data){const u=t.columns.find(e=>e.id===l);if(u){u.tasks.push(i.data);const m=document.querySelector(`#${u.id} .tasks-container`);m?m.appendChild(renderTask(i.data)):renderApp()}else renderApp();taskForm.reset(),populateStatusSelects(),document.getElementById('taskTitle').focus()}});
      addColumnForm.addEventListener('submit', async (e) => { e.preventDefault();const t=document.getElementById('columnTitle').value.trim(),o=document.getElementById('addColumnBoardId').value;if(!t||!o)return alert(t?"×©×’×™××”: ×—×¡×¨ ××–×”×” ×¤×¨×•×™×§×˜.":"×©× ×¢××•×“×” ×—×•×‘×”.");const n={id:generateId('col'),title:t,boardId:o,tasks:[]},r=await callGoogleScript('addColumn',n);if(r.success&&r.data){const d=appState.boards.find(e=>e.id===o);if(d){d.columns.push(r.data);if(d.id===appState.activeBoardId){const a=document.getElementById(o),s=a?.querySelector('.add-column-btn'),l=renderColumn(r.data,o);s?a.insertBefore(l,s):a?a.appendChild(l):renderApp()}}else renderApp();closeModal('addColumnModal')}});
      addBoardForm.addEventListener('submit', async (e) => { e.preventDefault();const t=document.getElementById('boardTitle').value.trim();if(!t)return alert("×©× ×¤×¨×•×™×§×˜ ×—×•×‘×”.");const o={id:generateId('board'),title:t},n=await callGoogleScript('addBoard',o);if(n.success&&n.data){appState.boards.push(n.data),switchTab(n.data.id),renderApp(),closeModal('addBoardModal');const r=tabsContainer.querySelector(`.tab[data-board-id="${n.data.id}"]`);r?.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'})}});
      editTaskForm.addEventListener('submit', async (e) => { e.preventDefault();const t=document.getElementById('editTaskId').value,o=document.getElementById('editTaskColumnId').value,n=document.getElementById('editTaskBoardId').value,r=document.getElementById('editTaskTitle').value.trim(),d=document.getElementById('editTaskDescription').value.trim(),a=editTaskPrioritySelect.value,s=editTaskDueDateDateInput.value,l=editTaskDueDateTimeInput.value;if(!t||!o||!n||!r||!a)return alert("×™×© ×œ××œ× ×©×“×•×ª ×—×•×‘×”.");let c=null;if(s&&l)c=`${s}T${l}`;else if(s)return alert("×™×© ×œ×¡×¤×§ ×’× ×©×¢×ª ×™×¢×“.");const i={id:t,title:r,description:d,status:a,dueDate:c},u=await callGoogleScript('updateTask',i);if(u.success&&u.data){const m=appState.boards.find(e=>e.id===n),p=m?.columns.find(e=>e.id===o),f=p?.tasks.findIndex(e=>e.id===t);f!==void 0&&f>-1&&p?(p.tasks[f]={...p.tasks[f],...u.data},updateTaskDOM(p.tasks[f])):renderApp(),closeModal('editTaskModal')}});
      function updateTaskDOM(taskData) { const taskEl = document.querySelector(`.task-card[data-task-id="${taskData.id}"]`); if (taskEl) { const updatedCard = renderTask(taskData); taskEl.parentNode.replaceChild(updatedCard, taskEl); checkDueDates(); } else { console.warn("Task DOM not found for update"); renderApp(); } } // Helper for cleaner edit update

      async function deleteTask(taskId, columnId, boardId) { const task = appState.boards.find(b=>b.id===boardId)?.columns.find(c=>c.id===columnId)?.tasks.find(t=>t.id===taskId); if (!confirm(`×œ××—×•×§ "${task?.title || '××©×™××” ×–×•'}"?`)) return; const result = await callGoogleScript('deleteTask', { taskId }); if (result.success && result.data?.id) { const column = appState.boards.find(b=>b.id===boardId)?.columns.find(c=>c.id===columnId); if (column) { const taskIndex = column.tasks.findIndex(t => t.id === result.data.id); if (taskIndex > -1) { column.tasks.splice(taskIndex, 1); const taskEl = document.querySelector(`.task-card[data-task-id="${result.data.id}"]`); if(taskEl) { taskEl.style.transition='opacity .3s ease, transform .3s ease, height .3s ease, margin .3s ease, padding .3s ease'; taskEl.style.opacity='0'; taskEl.style.transform='scale(0.8)'; taskEl.style.height='0'; taskEl.style.margin='0'; taskEl.style.padding='0'; setTimeout(()=>taskEl.remove(), 300); } else { renderApp(); } } else { renderApp(); } } else { renderApp(); } } }
      async function deleteColumn(columnId, boardId) { const board = appState.boards.find(b => b.id === boardId); const colIndex = board?.columns.findIndex(c => c.id === columnId); if (colIndex === undefined || colIndex === -1 || !board) return; const column = board.columns[colIndex]; if (!confirm(`×œ××—×•×§ ×¢××•×“×” "${column.title}" (${column.tasks.length} ××©×™××•×ª)?`)) return; const result = await callGoogleScript('deleteColumn', { columnId }); if (result.success && result.data?.id) { board.columns.splice(colIndex, 1); if (board.id === appState.activeBoardId) { const colEl = document.getElementById(result.data.id); if(colEl){ colEl.style.transition='opacity .3s ease, transform .3s ease, width .3s ease, margin .3s ease, padding .3s ease, min-width .3s ease'; colEl.style.opacity='0'; colEl.style.transform='scaleY(0.8)'; colEl.style.minWidth='0'; colEl.style.width='0'; colEl.style.margin='0'; colEl.style.padding='0'; setTimeout(()=>colEl.remove(), 300); } else { renderApp(); } } } }
      async function deleteBoard(boardId) { const boardIndex = appState.boards.findIndex(b => b.id === boardId); if (boardIndex === -1) return; const board = appState.boards[boardIndex]; const taskCount = board.columns.reduce((sum, col) => sum + col.tasks.length, 0); if (!confirm(`×œ××—×•×§ ×¤×¨×•×™×§×˜ "${board.title}" (${taskCount} ××©×™××•×ª)?`)) return; const result = await callGoogleScript('deleteBoard', { boardId }); if (result.success && result.data?.id) { appState.boards.splice(boardIndex, 1); if (appState.activeBoardId === result.data.id) { appState.activeBoardId = appState.boards.length > 0 ? appState.boards[0].id : null; } renderApp(); } }
      async function deleteStatus(statusIdToDelete) { if (appState.customStatuses.length <= 1) { alert("×œ× × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×”×¡×˜×˜×•×¡ ×”××—×¨×•×Ÿ."); return; } const statusIndex = appState.customStatuses.findIndex(s => s.id === statusIdToDelete); if (statusIndex === -1) return; const statusToDelete = appState.customStatuses[statusIndex]; const replacementStatusId = appState.customStatuses[0].id === statusIdToDelete ? appState.customStatuses[1].id : appState.customStatuses[0].id; if (!confirm(`×œ××—×•×§ ×¡×˜×˜×•×¡ "${statusToDelete.name}"? ××©×™××•×ª ×™×©×•×™×›×• ×œ×¡×˜×˜×•×¡ "${getStatusInfo(replacementStatusId).text}".`)) return; const result = await callGoogleScript('deleteStatus', { statusIdToDelete, replacementStatusId }); if (result.success && result.data?.id) { await fetchDataFromSheet(); } } // Refresh data after status delete
      async function editColumnTitle(columnId, boardId) { const board = appState.boards.find(b => b.id === boardId); const column = board?.columns.find(c => c.id === columnId); if (!column) return; const currentTitle = column.title; const newTitle = prompt(`×©× ×—×“×© ×œ×¢××•×“×” "${currentTitle}":`, currentTitle); if (newTitle === null) return; const finalTitle = newTitle.trim(); if (finalTitle && finalTitle !== currentTitle) { const result = await callGoogleScript('updateColumnTitle', { columnId, newTitle: finalTitle }); if (result.success && result.data) { column.title = result.data.title; if (board.id === appState.activeBoardId) { const colEl = document.getElementById(columnId); const titleEl = colEl?.querySelector('.column-title'); if (titleEl) { titleEl.textContent = finalTitle; titleEl.title = finalTitle; } else { renderApp(); } } } } else if (!finalTitle) { alert("×©× ×¢××•×“×” ×¨×™×§ ×œ× ×ª×§×™×Ÿ."); } }
      async function editBoardTitle(boardId) { const boardIndex = appState.boards.findIndex(b => b.id === boardId); if (boardIndex === -1) return; const currentTitle = appState.boards[boardIndex].title; const newTitle = prompt(`×©× ×—×“×© ×œ×¤×¨×•×™×§×˜ "${currentTitle}":`, currentTitle); if (newTitle === null) return; const finalTitle = newTitle.trim(); if (finalTitle && finalTitle !== currentTitle) { const result = await callGoogleScript('updateBoardTitle', { boardId, newTitle: finalTitle }); if (result.success && result.data) { appState.boards[boardIndex].title = result.data.title; const tabEl = tabsContainer.querySelector(`.tab[data-board-id="${boardId}"]`); if (tabEl) { const titleSpan = tabEl.querySelector('span'); if (titleSpan) { titleSpan.textContent = finalTitle; titleSpan.title = finalTitle; } const editBtn = tabEl.querySelector('.edit-tab-btn'); if(editBtn) editBtn.setAttribute('aria-label', `×¢×¨×•×š ${escapeHTML(finalTitle)}`); const delBtn = tabEl.querySelector('.delete-tab-btn'); if(delBtn) delBtn.setAttribute('aria-label', `××—×§ ${escapeHTML(finalTitle)}`); } else { renderTabs(); } } } else if (!finalTitle) { alert("×©× ×¤×¨×•×™×§×˜ ×¨×™×§ ×œ× ×ª×§×™×Ÿ."); } }

      // --- Periodic Due Date Check ---
      let dueDateCheckInterval = null;
      function checkDueDates() { const now = new Date(); appState.boards.forEach(b => { b.columns.forEach(c => { c.tasks.forEach(t => { const el = document.querySelector(`.task-card[data-task-id="${t.id}"]`); if (!el) return; let due=false; if(t.dueDate){ try { const d=new Date(t.dueDate); if(!isNaN(d) && d<now) due=true; } catch(e){} } el.classList.toggle('due-alarm', due); }); }); }); }
      function startDueDateChecker() { if (dueDateCheckInterval) clearInterval(dueDateCheckInterval); dueDateCheckInterval = setInterval(checkDueDates, 60 * 1000); }

      // --- Delegated Event Listeners Setup ---
      let boardClickListener = null; let sidebarClickListener = null;
      function setupDelegatedListeners() {
           if (boardClickListener) boardsContainer.removeEventListener('click', boardClickListener);
           boardClickListener = function(e) { const editT=e.target.closest('.edit-task-btn'),delT=e.target.closest('.delete-task-btn'),editC=e.target.closest('.edit-column-btn'),delC=e.target.closest('.delete-column-btn'); const task=e.target.closest('.task-card'),col=e.target.closest('.column'),brd=e.target.closest('.board'); if(editT&&task&&col&&brd)openEditTaskModal(task.dataset.taskId,col.dataset.columnId,brd.id); else if(delT&&task&&col&&brd)deleteTask(task.dataset.taskId,col.dataset.columnId,brd.id); else if(editC&&col&&brd)editColumnTitle(col.dataset.columnId,brd.id); else if(delC&&col&&brd)deleteColumn(col.dataset.columnId,brd.id); };
           boardsContainer.addEventListener('click', boardClickListener);
           if (sidebarClickListener) sidebarContainer.removeEventListener('click', sidebarClickListener);
           sidebarClickListener = function(e) { const delS=e.target.closest('.delete-status-btn'); if(delS&&!delS.disabled){ const id=delS.dataset.statusId; if(id)deleteStatus(id); } };
           sidebarContainer.addEventListener('click', sidebarClickListener);
           document.querySelectorAll('.modal').forEach(m => { m.removeEventListener('click', closeModalHandler); m.addEventListener('click', closeModalHandler); });
      }
      function closeModalHandler(e) { const m=e.currentTarget; if(e.target===m)closeModal(m.id); const c=e.target.closest('.close-modal-btn, .cancel-btn'); if(c&&c.dataset.modalId===m.id)closeModal(m.id); }

      // --- Initialization ---
      async function initializeApp() {
          console.log("Initializing Task Manager (Google Sheets Backend)...");
          await fetchDataFromSheet(); // Fetch initial data FIRST
          renderApp(); // Render based on fetched data
          startDueDateChecker(); // Start checking due dates AFTER render
          newTabBtn.addEventListener('click', openAddBoardModal);
          console.log("Task Manager Initialized with Google Sheets backend.");
      }
      async function fetchDataFromSheet() {
          const result = await callGoogleScript('getAllData');
          if (result.success && result.data) {
              console.log("Data fetched successfully.");
              appState.customStatuses = result.data.statuses || []; appState.boards = result.data.boards || [];
              if (appState.boards.length > 0) { const currentActiveIsValid = appState.activeBoardId && appState.boards.some(b => b.id === appState.activeBoardId); if (!currentActiveIsValid) { appState.activeBoardId = appState.boards[0].id; } } else { appState.activeBoardId = null; }
              if (appState.customStatuses.length === 0) { await addDefaultStatuses(); }
          } else { console.error("Failed to fetch initial data."); alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ×”×¨××©×•× ×™×™×."); boardsContainer.innerHTML = '<div style="padding: 30px; color: red; text-align: center; width: 100%;">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×.</div>'; if(newTabBtn) newTabBtn.disabled = true; if(taskForm) { taskForm.style.opacity='0.5'; taskForm.querySelectorAll('input, textarea, select, button').forEach(el => el.disabled = true); } }
      }
       async function addDefaultStatuses() {
            console.log("Adding default statuses to sheet...");
            const defaultStatuses = [ { id: generateId('status'), name: '×¨×’×™×œ', color: '#3498db' }, { id: generateId('status'), name: '×“×—×•×£', color: '#e74c3c' }, { id: generateId('status'), name: '×××ª×™×Ÿ', color: '#f39c12' }, { id: generateId('status'), name: '×‘×•×¦×¢', color: '#2ecc71' } ];
            let success = true;
            for (const status of defaultStatuses) { const result = await callGoogleScript('addStatus', status); if (result.success && result.data) { appState.customStatuses.push(result.data); } else { success = false; } }
            if (success) { console.log("Default statuses added."); populateStatusSelects(); } else { alert("××™×¨×¢×” ×©×’×™××” ×‘×”×•×¡×¤×ª ×¡×˜×˜×•×¡×™ ×‘×¨×™×¨×ª ××—×“×œ."); }
        }

      // Start the application
      initializeApp();

    }); // End of DOMContentLoaded
    // ]]>
  </script>
</body>
</html>
